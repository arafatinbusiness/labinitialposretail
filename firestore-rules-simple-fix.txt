rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isSignedIn() { 
      return request.auth != null; 
    }
    
    function isStoreOwner(storeId) { 
      return isSignedIn() && request.auth.uid == storeId; 
    }
    
    // Check if user is admin (store owner)
    function isAdmin(storeId) {
      return isStoreOwner(storeId);
    }

    // --- STORE DOCUMENT ---
    match /stores/{storeId} {
      // Store owners can read/write their store document
      // All authenticated users can read store info for testing
      allow read: if isSignedIn();
      allow write: if isStoreOwner(storeId);
      
      // Allow queries on stores collection
      allow list: if isSignedIn();
      
      // --- STOREUSERS SUBCOLLECTION (User Management) ---
      match /storeUsers/{userId} {
        // Admins can manage all users
        // All authenticated users can read for testing
        allow read: if isSignedIn();
        allow write: if isAdmin(storeId);
        allow list: if isSignedIn();
      }
      
      // --- PRODUCTS SUBCOLLECTION ---
      match /products/{productId} { 
        // All authenticated users can read products for POS testing
        allow read: if isSignedIn();
        allow write: if isAdmin(storeId);
        allow list: if isSignedIn();
      }
      
      // --- CATEGORIES SUBCOLLECTION ---
      match /categories/{categoryId} { 
        // All authenticated users can read categories for POS testing
        allow read: if isSignedIn();
        allow write: if isAdmin(storeId);
        allow list: if isSignedIn();
      }
      
      // --- CUSTOMERS SUBCOLLECTION ---
      match /customers/{customerId} { 
        // All authenticated users can read customers for testing
        allow read: if isSignedIn();
        allow write: if isAdmin(storeId);
        allow list: if isSignedIn();
      }
      
      // --- INVOICES SUBCOLLECTION ---
      match /invoices/{invoiceId} { 
        // All authenticated users can view and create invoices for testing
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update, delete: if isAdmin(storeId);
        allow list: if isSignedIn();
      }
      
      // --- EMPLOYEES SUBCOLLECTION ---
      match /employees/{employeeId} { 
        // Only admins can access employees
        allow read, write: if isAdmin(storeId);
        allow list: if isAdmin(storeId);
      }
      
      // --- ATTENDANCE SUBCOLLECTION ---
      match /attendance/{recordId} { 
        // Only admins can access attendance
        allow read, write: if isAdmin(storeId);
        allow list: if isAdmin(storeId);
      }
      
      // --- SALARIES SUBCOLLECTION ---
      match /salaries/{recordId} { 
        // Only admins can access salaries
        allow read, write: if isAdmin(storeId);
        allow list: if isAdmin(storeId);
      }
      
      // --- SETTINGS DOCUMENT ---
      match /settings/store { 
        // Only admins can access settings
        allow read, write: if isAdmin(storeId);
      }
    }
    
    // --- PUBLIC INVOICE VIEW (Allow public access to invoice verification) ---
    match /publicInvoices/{invoiceId} {
      allow read: if true; // Public read access for invoice verification
      allow write: if false; // No public write access
    }
    
    // --- DEFAULT DENY RULE ---
    match /{document=**} { 
      allow read, write: if false; 
    }
  }
}
